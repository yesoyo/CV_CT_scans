# Анализ КТ грудной клетки (норма / патология)

## Описание решения
Сервис для автоматизированной обработки КТ грудной клетки.  
Позволяет загружать архивы с DICOM-срезами, выполнять предобработку, инференс с помощью моделей (2.5D / 3D) и получать результат классификации: **норма** или **патология**.  

## Основные возможности
- Приём входных данных в формате `zip` с DICOM-срезами.  
- Предобработка и нормализация изображений.  
- Поддержка инференса с 2.5D и 3D моделями.  
- REST API (FastAPI) для интеграции.  
- Веб-интерфейс на HTML/JS для загрузки файлов и просмотра результатов.  
- Генерация отчётов по результатам анализа.  

### Ограничения
- Модели обучены на ограниченном наборе данных (может снижаться качество на новых типах исследований).  
- Поддерживается только бинарная классификация («норма» / «патология»).  
- Для стабильной работы желательно наличие GPU.  

## Системные требования
- **ОС:** Linux / Windows / macOS  
- **Python:** 3.9+  
- **Зависимости:**  
  - `torch`, `torchvision`  
  - `fastapi`, `uvicorn`  
  - `pydicom`, `numpy`, `pandas`  
  - `scikit-learn`  
- **GPU (опционально):** NVIDIA CUDA  

## Быстрый старт

### Запуск локально
1. Клонировать репозиторий.

2. Установить зависимости:

   ```bash
   pip install -r requirements.txt
````

3. Запустить сервис:

   ```bash
   uvicorn app.main:app --reload
   ```

4. Перейти в браузере по адресу:

   ```
   http://127.0.0.1:8000
   ```

### Запуск в Docker

#### 1. Сборка и запуск

Для запуска через Docker Compose:

```bash
docker-compose up --build
```

Сервис будет доступен по адресу:

```
http://localhost:8000
```

#### 2. Используемые образы

В `Dockerfile` используется официальный образ PyTorch с поддержкой CUDA:

```dockerfile
FROM pytorch/pytorch:2.4.0-cuda12.1-cudnn9-runtime
```

Это гарантирует работу моделей на GPU (если доступен).

#### 3. Переменные окружения

В `docker-compose.yml` задаются основные параметры:

* `K_SLICES=5` — количество используемых срезов из серии.
* `IMG_SIZE=320` — размер изображений для модели.
* `UNCERT_LOW=0.45` и `UNCERT_HIGH=0.55` — пороги неопределённости для классификации.
* `DEVICE=cuda` — использование GPU (можно поменять на `cpu` для отладки).

#### 4. GPU-ускорение

В `docker-compose.yml` включён блок:

```yaml
deploy:
  resources:
    reservations:
      devices:
        - capabilities: [gpu]
```

Для корректной работы потребуется:

* Установленный драйвер NVIDIA.
* `nvidia-container-toolkit` (для передачи GPU в контейнер).

Проверка:

```bash
nvidia-smi
```

и

```bash
docker run --rm --gpus all nvidia/cuda:12.2.0-base nvidia-smi
```

#### 5. Тома

Примонтированы внешние директории:

* `./models:/app/models` — сохранённые веса моделей.
* `./reports:/app/reports` — экспорт отчётов.

#### 6. Пример запроса

После запуска контейнера можно отправить запрос:

```bash
curl -X POST "http://127.0.0.1:8000/predict" \
     -F "file=@example_ct.zip"
```

## Структура проекта

```
CV_CT_SCANS/
│── ct-data-and-models/          # Данные и ноутбуки для анализа
│   ├── runs/                    # Эксперименты и результаты обучения
│   ├── CT_CV_Scans_big_data.ipynb
│   ├── CT_CV_Scans_final.ipynb
│   ├── OpenNiiGz.ipynb
│   └── manifest.csv             # Манифест данных
│
│── ct-service/                  # Основной сервис
│   ├── app/
│   │   ├── static/assets/       # Фронтенд (CSS/JS)
│   │   │   ├── css/styles.css
│   │   │   └── js/ (app.js, api.js, config.js, ui.js)
│   │   ├── index.html           # Веб-интерфейс
│   │   ├── main.py              # Точка входа FastAPI
│   │   ├── router_logic.py      # Логика маршрутов
│   │   ├── config.py            # Конфигурация
│   │   ├── dicom_reader.py      # Загрузка и чтение DICOM
│   │   ├── preprocess.py        # Препроцессинг данных
│   │   ├── model2p5d.py         # Инференс 2.5D модели
│   │   ├── model3d.py           # Инференс 3D модели
│   │   ├── report.py            # Генерация отчётов
│   │   ├── io_utils.py          # Вспомогательные функции
│   │   └── schemas.py           # Pydantic-схемы
│   │
│   ├── models/                  # Сохранённые веса
│   │   ├── resnet2p5d.pt
│   │   └── resnet2p5d_old.pt
│   │
│   ├── reports/                 # Сохранённые отчёты
│   ├── tmp/                     # Временные файлы
│   ├── Dockerfile
│   ├── docker-compose.yml
│   └── requirements.txt
│
└── README.md
```

## Дальнейшее развитие

* Добавление классификации по типам патологий.
* Обучение на большем количестве данных для повышения обобщающей способности.
* Поддержка дополнительных форматов (NIfTI, JPEG, PNG).
